<script>
document.getElementById("imagenes").addEventListener("change", function () {
    const list = document.getElementById("fileList");
    list.innerHTML = "";

    const files = Array.from(this.files).slice(0, 5);

    files.forEach(file => {
        const item = document.createElement("div");
        item.textContent = "• " + file.name;
        list.appendChild(item);
    });
});

document.getElementById("claimForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);

    // Convertir inputs a JSON
    const jsonData = {};
    formData.forEach((value, key) => {
        if (!key.includes("imagenes")) {
            jsonData[key] = value;
        }
    });

    // Procesar archivos a Base64
    const files = Array.from(document.getElementById("imagenes").files).slice(0, 5);
    jsonData.imagenes = [];

    async function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve({
                nombre: file.name,
                tipo: file.type,
                contenido: reader.result.split(",")[1] // solo Base64
            });
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    for (let file of files) {
        const base64File = await fileToBase64(file);
        jsonData.imagenes.push(base64File);
    }

    console.log("JSON enviado:", jsonData);

    const endpoint = "https://aff94820bd7ae1c68adacb1a608c7d.5c.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/491ec07957c5495aa97185d178dd43a4/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=Sf47I0SBWS4A10rbImuKZa4kAvtGlTTHKHr6svEuf5Y";

    try {
        const response = await fetch(endpoint, {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(jsonData)
        });

        if (response.ok) {
            alert("Reclamación enviada con éxito.");
            form.reset();
            document.getElementById("fileList").innerHTML = "";
        } else {
            alert("Error al enviar. Código: " + response.status);
        }
    } catch (error) {
        alert("Error de conexión: " + error);
    }
});
</script>
